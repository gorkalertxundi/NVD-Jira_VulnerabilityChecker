import json
import requests

# NVD API endpoint
nvd_url = 'https://services.nvd.nist.gov/rest/json/cve/1.1/CVE-2022-0000'

# Jira API endpoint
jira_url = 'https://your-jira-instance.com/rest/api/2/issue'

# Jira API auth credentials
jira_username = 'your-username'
jira_password = 'your-password'

# Jira search API endpoint
jira_search_url = jira_url + '/search'

# List of CPE items to search for
cpe_list = ['cpe:2.3:o:microsoft:windows_server_2016:*:*:*:*:*:*:*',
            'cpe:2.3:o:redhat:enterprise_linux:7:*:*:*:*:*:*']

# Search for vulnerabilities on NVD API for each CPE item
for cpe in cpe_list:
    nvd_response = requests.get(nvd_url, params={'cpe': cpe})
    nvd_data = json.loads(nvd_response.text)

    # Check if any vulnerabilities were found
    if nvd_data['result']['totalRecords'] > 0:
        cve_id = nvd_data['result']['CVE_Items'][0]['cve']['CVE_data_meta']['ID']
        # Check if Jira issue already exists with the same CVE ID
        jira_search_response = requests.get(jira_search_url, auth=(jira_username, jira_password), params={'jql': f'cf[10800] = "{cve_id}"'})
        jira_search_data = json.loads(jira_search_response.text)
        if jira_search_data['total'] > 0:
            print(f"Jira issue already exists with the same CVE ID: {cve_id}")
        else:
            # Create a new issue in Jira
            jira_data = {
                "fields": {
                    "project": {"key": "YOUR_PROJECT_KEY"},
                    "summary": nvd_data['result']['CVE_Items'][0]['cve']['description']['description_data'][0]['value'],
                    "description": nvd_data['result']['CVE_Items'][0]['cve']['description']['description_data'][0]['value'],
                    "issuetype": {"name": "Vulnerability"},
                    "customfield_10800": cve_id
                }
            }

            jira_response = requests.post(
                jira_url, auth=(jira_username, jira_password), json=jira_data)
            print(jira_response.status_code)
    else:
        print(f"No vulnerabilities found for {cpe}")
